<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Gesture-Controlled Car Game</title>
    <style type="text/css">
        /*Styling the game*/
        body {
            height: 100%;
            width: 100%;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #container {
            position: relative;
            height: 100vh;
            width: 25%;
            left: 35%;
            background: linear-gradient(180deg, #2d3748 0%, #1a202c 100%);
            overflow: hidden;
            border: 3px solid #4a5568;
            border-radius: 10px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        /*Styling the Road Surface Markings*/
        .line_1,
        .line_2,
        .line_3,
        .line_4 {
            position: absolute;
            height: 200px;
            width: 4%;
            margin-left: 48%;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.8) 0%, rgba(255, 255, 255, 0.3) 100%);
            border-radius: 2px;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
        }

        .line_1 {
            top: -150px;
        }

        .line_2 {
            top: 145px;
        }

        .line_3 {
            top: 440px;
        }

        .line_4 {
            top: 735px;
        }

        .line_5,
        .line_6 {
            position: absolute;
            width: 10px;
            height: 100%;
            background: linear-gradient(180deg, #e53e3e 0%, #c53030 100%);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .line_6 {
            margin-left: 98%;
        }

        /*Styling the cars*/
        .car {
            position: absolute;
            height: 60px;
            width: 40px;
            border-radius: 8px;
            box-shadow: 0px 4px 15px rgba(0, 0, 0, 0.4);
            /* Removed transition to prevent slow movement */
        }

        #car {
            bottom: 8%;
            left: 60%;
            background: linear-gradient(145deg, #ffd93d 0%, #ff9500 100%);
            border: 2px solid #ff9500;
        }

        .f_glass,
        .b_glass {
            position: absolute;
            height: 20%;
            width: 60%;
            margin-left: 20%;
            background: linear-gradient(145deg, #2d3748 0%, #4a5568 100%);
            border-radius: 3px;
        }

        .f_glass {
            top: 15%;
            border-radius: 0px 0px 5px 5px;
        }

        .b_glass {
            bottom: 15%;
            border-radius: 5px 5px 0px 0px;
        }

        .f_light_l,
        .f_light_r {
            position: absolute;
            height: 10%;
            width: 20%;
            top: -6%;
            background: linear-gradient(145deg, #f7fafc 0%, #e2e8f0 100%);
            border-radius: 5px 5px 0px 0px;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
        }

        .f_light_l {
            margin-left: 10%;
        }

        .f_light_r {
            margin-left: 70%;
        }

        .b_light_l,
        .b_light_r {
            position: absolute;
            height: 10%;
            width: 20%;
            top: 96%;
            background: linear-gradient(145deg, #fc8181 0%, #e53e3e 100%);
            border-radius: 0px 0px 5px 5px;
            box-shadow: 0 0 8px rgba(229, 62, 62, 0.6);
        }

        .b_light_l {
            margin-left: 10%;
        }

        .b_light_r {
            margin-left: 70%;
        }

        .rev_f_light_l,
        .rev_f_light_r {
            position: absolute;
            height: 10%;
            width: 20%;
            top: 96%;
            background: linear-gradient(145deg, #f7fafc 0%, #e2e8f0 100%);
            border-radius: 0px 0px 5px 5px;
            box-shadow: 0 0 8px rgba(255, 255, 255, 0.6);
        }

        .rev_f_light_l {
            margin-left: 10%;
        }

        .rev_f_light_r {
            margin-left: 70%;
        }

        .rev_b_light_l,
        .rev_b_light_r {
            position: absolute;
            height: 10%;
            width: 20%;
            top: -6%;
            background: linear-gradient(145deg, #fc8181 0%, #e53e3e 100%);
            border-radius: 5px 5px 0px 0px;
            box-shadow: 0 0 8px rgba(229, 62, 62, 0.6);
        }

        .rev_b_light_l {
            margin-left: 10%;
        }

        .rev_b_light_r {
            margin-left: 70%;
        }

        .f_tyre_l,
        .f_tyre_r,
        .b_tyre_l,
        .b_tyre_r {
            position: absolute;
            height: 20%;
            width: 10%;
            background: linear-gradient(145deg, #4a5568 0%, #2d3748 100%);
            border: 1px solid #1a202c;
        }

        .f_tyre_l {
            top: 20%;
            left: -10%;
            border-radius: 5px 0px 0px 5px;
        }

        .f_tyre_r {
            top: 20%;
            left: 100%;
            border-radius: 0px 5px 5px 0px;
        }

        .b_tyre_l {
            top: 70%;
            left: -10%;
            border-radius: 5px 0px 0px 5px;
        }

        .b_tyre_r {
            top: 70%;
            left: 100%;
            border-radius: 0px 5px 5px 0px;
        }

        #car_1 {
            top: -100px;
            left: 60%;
            background: linear-gradient(145deg, #fc8181 0%, #e53e3e 100%);
            border: 2px solid #c53030;
        }

        #car_2 {
            top: -200px;
            left: 40%;
            background: linear-gradient(145deg, #63b3ed 0%, #3182ce 100%);
            border: 2px solid #2c5282;
        }

        #car_3 {
            top: -350px;
            left: 50%;
            background: linear-gradient(145deg, #68d391 0%, #38a169 100%);
            border: 2px solid #2f855a;
        }

        /*Styling the Restart feature*/
        #restart_div {
            position: absolute;
            height: 100%;
            width: 100%;
            background: linear-gradient(135deg, rgba(45, 55, 72, 0.95) 0%, rgba(26, 32, 44, 0.95) 100%);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 40px;
            text-align: center;
            display: none;
            backdrop-filter: blur(10px);
        }

        /*Text on the restart button*/
        #restart {
            border: none;
            padding: 25px 35px;
            color: white;
            background: linear-gradient(145deg, #805ad5 0%, #553c9a 100%);
            font-size: 30px;
            margin-top: 30%;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(128, 90, 213, 0.4);
            transition: all 0.3s ease;
            font-weight: bold;
        }

        #restart:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(128, 90, 213, 0.6);
        }

        #restart:active {
            transform: translateY(0);
        }

        .small_text {
            font-size: 15px;
            opacity: 0.8;
        }

        /*Styling the score board*/
        #score_div {
            position: absolute;
            margin-top: 20%;
            margin-left: 10%;
            font-size: 35px;
            background: linear-gradient(145deg, #f7fafc 0%, #edf2f7 100%);
            color: #2d3748;
            padding: 15px 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-radius: 15px;
            border: 3px solid #e2e8f0;
            font-weight: bold;
            z-index: 1000;
        }

        .return {
            position: absolute;
            padding: 15px 25px;
            font-size: 24px;
            text-align: center;
            cursor: pointer;
            outline: none;
            color: white;
            background: linear-gradient(145deg, #48bb78 0%, #38a169 100%);
            border: none;
            border-radius: 15px;
            box-shadow: 0 8px 20px rgba(72, 187, 120, 0.4);
            top: 1%;
            left: 1%;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .return:hover {
            background: linear-gradient(145deg, #38a169 0%, #2f855a 100%);
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(72, 187, 120, 0.6);
        }

        .return:active {
            transform: translateY(0);
            box-shadow: 0 6px 15px rgba(72, 187, 120, 0.4);
        }

        /* Webcam and gesture controls styling */
        #webcam-container {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 10px;
            z-index: 1000;
        }

        #webcam-container canvas,
        #webcam-container video {
            border-radius: 8px;
            width: 150px !important;
            height: 150px !important;
        }

        #label-container {
            position: absolute;
            top: 180px;
            right: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 12px;
            min-width: 150px;
            z-index: 1000;
        }

        #label-container div {
            background-color: rgba(255, 255, 255, 0.1);
            margin: 2px 0;
            padding: 5px;
            border-radius: 4px;
            font-family: monospace;
        }

        #start-gesture-btn {
            position: absolute;
            top: 50px;
            left: 10px;
            background-color: #4285f4;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 1000;
        }

        #start-gesture-btn:hover {
            background-color: #3367d6;
        }

        #gesture-status {
            position: absolute;
            top: 100px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 1000;
        }

        /* Model Upload Overlay */
        .model-upload-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .model-upload-container {
            background: linear-gradient(145deg, #2d3748 0%, #1a202c 100%);
            padding: 50px;
            border-radius: 25px;
            max-width: 550px;
            width: 90%;
            color: white;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 3px solid #4a5568;
        }

        .model-upload-container h2 {
            color: #805ad5;
            margin-bottom: 25px;
            font-size: 32px;
            font-weight: bold;
        }

        .model-upload-container p {
            margin-bottom: 18px;
            line-height: 1.8;
            color: #e2e8f0;
            font-size: 16px;
        }

        .url-input-container {
            margin: 30px 0;
        }

        #model-url-input {
            width: 100%;
            padding: 18px;
            font-size: 16px;
            border: 3px solid #805ad5;
            border-radius: 12px;
            background: linear-gradient(145deg, #4a5568 0%, #2d3748 100%);
            color: white;
            box-sizing: border-box;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }

        #model-url-input:focus {
            outline: none;
            border-color: #9f7aea;
            box-shadow: 0 0 20px rgba(128, 90, 213, 0.4);
            transform: translateY(-2px);
        }

        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 25px;
        }

        .btn {
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(145deg, #805ad5 0%, #553c9a 100%);
            color: white;
        }

        .btn-primary:hover {
            background: linear-gradient(145deg, #9f7aea 0%, #805ad5 100%);
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(128, 90, 213, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(145deg, #718096 0%, #4a5568 100%);
            color: white;
        }

        .btn-secondary:hover {
            background: linear-gradient(145deg, #8a95a1 0%, #718096 100%);
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(113, 128, 150, 0.4);
        }

        .example-url {
            background: linear-gradient(145deg, #4a5568 0%, #2d3748 100%);
            padding: 15px;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #9f7aea;
            margin: 15px 0;
            word-break: break-all;
            border: 2px solid #805ad5;
        }

        .instructions-list {
            text-align: left;
            margin: 25px 0;
            background: linear-gradient(145deg, rgba(74, 85, 104, 0.3) 0%, rgba(45, 55, 72, 0.3) 100%);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid #4a5568;
        }

        .instructions-list li {
            margin-bottom: 12px;
            color: #e2e8f0;
            font-size: 15px;
        }

        .warning-text {
            color: #fc8181;
            font-size: 14px;
            margin-top: 12px;
            font-weight: bold;
        } 0, 0, 0.9);
            z-index: 3000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .model-upload-container {
            background-color: #2c2c2c;
            padding: 40px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            color: white;
            text-align: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .model-upload-container h2 {
            color: #4285f4;
            margin-bottom: 20px;
            font-size: 28px;
        }

        .model-upload-container p {
            margin-bottom: 15px;
            line-height: 1.6;
            color: #cccccc;
        }

        .url-input-container {
            margin: 25px 0;
        }

        #model-url-input {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #4285f4;
            border-radius: 8px;
            background-color: #404040;
            color: white;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        #model-url-input:focus {
            outline: none;
            border-color: #66a3ff;
            box-shadow: 0 0 10px rgba(66, 133, 244, 0.3);
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .btn-primary {
            background-color: #4285f4;
            color: white;
        }

        .btn-primary:hover {
            background-color: #3367d6;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #545b62;
            transform: translateY(-2px);
        }

        .example-url {
            background-color: #404040;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            color: #66a3ff;
            margin: 10px 0;
            word-break: break-all;
        }

        .instructions-list {
            text-align: left;
            margin: 20px 0;
        }

        .instructions-list li {
            margin-bottom: 8px;
            color: #cccccc;
        }

        .warning-text {
            color: #ff6b6b;
            font-size: 14px;
            margin-top: 10px;
        }

        /* Gesture Activation Overlay */
        .gesture-activation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .gesture-activation-container {
            background: linear-gradient(145deg, #2d3748 0%, #1a202c 100%);
            padding: 50px;
            border-radius: 25px;
            max-width: 550px;
            width: 90%;
            color: white;
            text-align: center;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border: 3px solid #4a5568;
        }

        .gesture-activation-container h2 {
            color: #805ad5;
            margin-bottom: 25px;
            font-size: 32px;
            font-weight: bold;
        }

        .gesture-activation-container p {
            margin-bottom: 18px;
            line-height: 1.8;
            color: #e2e8f0;
            font-size: 16px;
        }

        .success-icon {
            font-size: 60px;
            color: #48bb78;
            margin-bottom: 25px;
            text-shadow: 0 0 20px rgba(72, 187, 120, 0.5);
        }

        .webcam-permission-info {
            background: linear-gradient(145deg, rgba(255, 152, 0, 0.2) 0%, rgba(237, 137, 54, 0.2) 100%);
            padding: 20px;
            border-radius: 12px;
            margin: 25px 0;
            border: 2px solid #ed8936;
        }

        .webcam-permission-info h4 {
            color: #ed8936;
            margin: 0 0 12px 0;
            font-size: 18px;
            font-weight: bold;
        }

        .instructions h3 {
            color: #4285f4;
            margin-top: 0;
        }

        .instructions button {
            background-color: #8a64ff;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px;
        }
    </style>
</head>

<body>
    <!-- Model Upload Overlay -->
    <div id="model-upload-overlay" class="model-upload-overlay">
        <div class="model-upload-container">
            <h2>🎮 Gesture-Controlled Car Game</h2>
            <p>Welcome! To play this game with gesture controls, you'll need to provide your Teachable Machine model URL.</p>
            
            <div class="instructions-list">
                <strong>How to get your model URL:</strong>
                <ol>
                    <li>Go to <a href="https://teachablemachine.withgoogle.com" target="_blank" style="color: #4285f4;">Teachable Machine</a></li>
                    <li>Create an Image Project</li>
                    <li>Train classes for: <strong>left</strong>, <strong>right</strong>, <strong>up</strong>, <strong>down</strong></li>
                    <li>Export your model and copy the shareable link</li>
                </ol>
            </div>

            <div class="example-url">
                Example: https://teachablemachine.withgoogle.com/models/YourModelID/
            </div>

            <div class="url-input-container">
                <input type="text" id="model-url-input" placeholder="Paste your Teachable Machine model URL here..." />
                <div class="warning-text" id="url-warning" style="display: none;">
                    Please enter a valid Teachable Machine URL
                </div>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="validateModelURL()">
                    📤 Submit Model URL
                </button>
            </div>
        </div>
    </div>

    <!-- Gesture Activation Overlay -->
    <div id="gesture-activation-overlay" class="gesture-activation-overlay">
        <div class="gesture-activation-container">
            <div class="success-icon">✅</div>
            <h2>Model URL Submitted Successfully!</h2>
            <p>Your Teachable Machine model has been validated and is ready to use.</p>
            
            <div class="webcam-permission-info">
                <h4>📷 Webcam Access Required</h4>
                <p>The next step will request access to your webcam for gesture recognition. Please allow camera permissions when prompted.</p>
            </div>

            <p><strong>Gesture Controls:</strong></p>
            <div class="instructions-list" style="text-align: left; margin: 15px 0;">
                <p>✋ <strong>Left gesture</strong> - Move car left</p>
                <p>✋ <strong>Right gesture</strong> - Move car right</p>
                <p>✋ <strong>Up gesture</strong> - Move car up</p>
                <p>✋ <strong>Down gesture</strong> - Move car down</p>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="activateGestureMode()">
                    🎮 Activate Gesture Mode
                </button>
            </div>
        </div>
    </div>

    <!--Score board-->
    <div id="score_div">
        Score: <span id="score">0</span>
    </div>

    <!--Final start overlay-->
    <div id="final-start-overlay" class="gesture-activation-overlay">
        <div class="gesture-activation-container">
            <div class="success-icon">🎮</div>
            <h2>Gesture Control Ready!</h2>
            <p>Your webcam is active and gesture recognition is enabled.</p>
            <p><strong>You're all set to play!</strong></p>

            <div class="webcam-permission-info">
                <h4>🎯 Game Instructions</h4>
                <p>Use hand gestures to control your car and avoid obstacles. Your score increases as you survive longer!</p>
            </div>

            <div class="button-group">
                <button class="btn btn-primary" onclick="startGame()">
                    🚗 Start Game!
                </button>
            </div>
        </div>
    </div>
    
    <!--Gesture status-->
    <div id="gesture-status">Gesture Control: OFF</div>

    <!--Webcam container-->
    <div id="webcam-container" style="display: none;"></div>
    <div id="label-container" style="display: none;"></div>

    <!--One div for the rest of the elements of the game since they all will come under one area-->
    <div id="container">
        <!--div for the Road Surface marking-->
        <div class="line_1"></div>
        <div class="line_2"></div>
        <div class="line_3"></div>
        <div class="line_4"></div>
        <div class="line_5"></div>
        <div class="line_6"></div>
        <!--div for the car user will control-->
        <div id="car" class="car">
            <div class="f_glass"></div>
            <div class="b_glass"></div>
            <div class="f_light_l"></div>
            <div class="f_light_r"></div>
            <div class="b_light_l"></div>
            <div class="b_light_r"></div>
            <div class="f_tyre_l"></div>
            <div class="f_tyre_r"></div>
            <div class="b_tyre_l"></div>
            <div class="b_tyre_r"></div>
        </div>
        <!-- id with car_1, car_2 and car_3 is for the obstacle cars-->
        <div id="car_1" class="car">
            <div class="f_glass"></div>
            <div class="b_glass"></div>
            <div class="rev_f_light_l"></div>
            <div class="rev_f_light_r"></div>
            <div class="rev_b_light_l"></div>
            <div class="rev_b_light_r"></div>
            <div class="f_tyre_l"></div>
            <div class="f_tyre_r"></div>
            <div class="b_tyre_l"></div>
            <div class="b_tyre_r"></div>
        </div>
        <div id="car_2" class="car">
            <div class="f_glass"></div>
            <div class="b_glass"></div>
            <div class="rev_f_light_l"></div>
            <div class="rev_f_light_r"></div>
            <div class="rev_b_light_l"></div>
            <div class="rev_b_light_r"></div>
            <div class="f_tyre_l"></div>
            <div class="f_tyre_r"></div>
            <div class="b_tyre_l"></div>
            <div class="b_tyre_r"></div>
        </div>
        <div id="car_3" class="car">
            <div class="f_glass"></div>
            <div class="b_glass"></div>
            <div class="rev_f_light_l"></div>
            <div class="rev_f_light_r"></div>
            <div class="rev_b_light_l"></div>
            <div class="rev_b_light_r"></div>
            <div class="f_tyre_l"></div>
            <div class="f_tyre_r"></div>
            <div class="b_tyre_l"></div>
            <div class="b_tyre_r"></div>
        </div>
        <!--div for the restart feature-->
        <div id="restart_div">
            <button id="restart">
                <p>Restart</p>
                <small class="small_text">(press Enter)</small>
            </button>
        </div>
    </div>
    <button id="return" class="return">↵</button>

    <!--Import TensorFlow and Teachable Machine-->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.3/dist/teachablemachine-image.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    
    <script type="text/javascript">
        // Model URL will be set by user and stored
        let MODEL_URL = '';
        let STORED_MODEL_URL = ''; // Store the URL for restart functionality
        
        let model, webcam, labelContainer, maxPredictions;
        let isIos = false;
        let gestureControlActive = false;
        let currentGesture = 'none';
        let gestureConfidence = 0;
        let gameStarted = false;
        
        // Game variables
        var anim_id;
        var container, car, car_1, car_2, car_3, line_1, line_2, line_3, line_4, line_5, line_6, restart_div, restart_btn, score;
        var container_left, container_width, container_height, car_width, car_height, line_width_l, line_width_r;
        var game_over = false, score_counter = 1, speed = 5, line_speed = 2;
        var move_right = false, move_left = false, move_up = false, move_down = false;

        // Fix for iOS devices
        if (window.navigator.userAgent.indexOf('iPhone') > -1 || window.navigator.userAgent.indexOf('iPad') > -1) {
            isIos = true;
        }

        // Check if we have a stored model URL on page load
        window.addEventListener('load', function() {
            // Check if we're coming from a return and have a stored URL
            const urlParams = new URLSearchParams(window.location.search);
            const storedUrl = urlParams.get('modelUrl');
            
            if (storedUrl) {
                MODEL_URL = storedUrl;
                STORED_MODEL_URL = storedUrl;
                document.getElementById('model-upload-overlay').style.display = 'none';
                // Go to gesture activation for return cases
                document.getElementById('gesture-activation-overlay').style.display = 'flex';
            }
        });

        function validateModelURL() {
            const urlInput = document.getElementById('model-url-input');
            const warning = document.getElementById('url-warning');
            const url = urlInput.value.trim();
            
            // Validate URL
            if (!url) {
                warning.textContent = 'Please enter a model URL';
                warning.style.display = 'block';
                return;
            }
            
            // Check if it's a valid Teachable Machine URL
            if (!url.includes('teachablemachine.withgoogle.com/models/')) {
                warning.textContent = 'Please enter a valid Teachable Machine URL';
                warning.style.display = 'block';
                return;
            }
            
            // Ensure URL ends with /
            MODEL_URL = url.endsWith('/') ? url : url + '/';
            STORED_MODEL_URL = MODEL_URL; // Store the URL for restart functionality
            
            // Hide model upload overlay and show gesture activation
            document.getElementById('model-upload-overlay').style.display = 'none';
            document.getElementById('gesture-activation-overlay').style.display = 'flex';
        }

        function restartGameWithoutReload() {
            // Reset all game variables
            game_over = false;
            score_counter = 1;
            speed = 5;
            line_speed = 2;
            
            // Reset car positions
            car.css({
                'bottom': '8%',
                'left': '60%',
                'top': 'auto'
            });
            
            // Reset obstacle car positions
            car_1.css({
                'top': '-100px',
                'left': '60%'
            });
            
            car_2.css({
                'top': '-200px',
                'left': '40%'
            });
            
            car_3.css({
                'top': '-350px',
                'left': '50%'
            });
            
            // Reset road lines
            line_1.css('top', '-150px');
            line_2.css('top', '145px');
            line_3.css('top', '440px');
            line_4.css('top', '735px');
            
            // Reset score
            score.text('0');
            
            // Stop all movements
            stopAllMovement();
            
            // Hide restart div
            restart_div.hide();
            
            // Restart the game loop
            anim_id = requestAnimationFrame(repeat);
            
            // Gesture control should still be active, no need to reinitialize webcam
            if (gestureControlActive && webcam) {
                document.getElementById('gesture-status').innerHTML = 'Gesture Control: ON';
            }
        }

        async function activateGestureMode() {
            try {
                // Hide gesture activation overlay
                document.getElementById('gesture-activation-overlay').style.display = 'none';
                
                // Show loading status
                document.getElementById('gesture-status').innerHTML = 'Loading model and webcam...';
                
                // Initialize gesture control
                await initGestureControl();
                
                // Show final start overlay
                document.getElementById('final-start-overlay').style.display = 'flex';
                
            } catch (error) {
                console.error('Error activating gesture mode:', error);
                alert('Error setting up gesture control. Please try again.');
                // Go back to gesture activation screen
                document.getElementById('gesture-activation-overlay').style.display = 'flex';
            }
        }

        function startGame() {
            // Hide final overlay and start game
            document.getElementById('final-start-overlay').style.display = 'none';
            initGame();
        }

        function playWithKeyboard() {
            MODEL_URL = ''; // No model needed for keyboard controls
            document.getElementById('model-upload-overlay').style.display = 'none';
            initGame();
        }

        function hideInstructions() {
            document.getElementById('instructions').style.display = 'none';
        }

        function initGame() {
            if (gameStarted) return;
            gameStarted = true;
            
            // jQuery DOM ready equivalent
            container = $('#container');
            car = $('#car');
            car_1 = $('#car_1');
            car_2 = $('#car_2');
            car_3 = $('#car_3');
            line_1 = $('.line_1');
            line_2 = $('.line_2');
            line_3 = $('.line_3');
            line_4 = $('.line_4');
            line_5 = $('.line_5');
            line_6 = $('.line_6');
            restart_div = $('#restart_div');
            restart_btn = $('#restart');
            score = $('#score');

            // Setup initial values
            container_left = parseInt(container.css('left'));
            container_width = parseInt(container.width());
            container_height = parseInt(container.height());
            car_width = parseInt(car.width());
            car_height = parseInt(car.height());
            line_width_l = parseInt(line_5.width());
            line_width_r = parseInt(line_6.width());

            // Start game loop
            anim_id = requestAnimationFrame(repeat);

            // Restart button functionality - No page reload, just reset game state
            restart_btn.click(function () {
                // Reset game state without page reload to keep webcam active
                restartGameWithoutReload();
            });

            // Keep keyboard controls as backup
            $(document).on('keydown', function (e) {
                if (game_over === false && !gestureControlActive) {
                    var key = e.keyCode;
                    if (key === 37 && move_left === false) {
                        move_left = requestAnimationFrame(left);
                    } else if (key === 39 && move_right === false) {
                        move_right = requestAnimationFrame(right);
                    } else if (key === 38 && move_up === false) {
                        move_up = requestAnimationFrame(up);
                    } else if (key === 40 && move_down === false) {
                        move_down = requestAnimationFrame(down);
                    }
                }
            });

            $(document).on('keyup', function (e) {
                if (game_over === false && !gestureControlActive) {
                    var key = e.keyCode;
                    if (key === 37) {
                        cancelAnimationFrame(move_left);
                        move_left = false;
                    } else if (key === 39) {
                        cancelAnimationFrame(move_right);
                        move_right = false;
                    } else if (key === 38) {
                        cancelAnimationFrame(move_up);
                        move_up = false;
                    } else if (key === 40) {
                        cancelAnimationFrame(move_down);
                        move_down = false;
                    }
                }
            });
        }

        // Gesture control initialization
        async function initGestureControl() {
            if (!MODEL_URL) {
                throw new Error('No model URL provided');
            }
            
            try {
                const modelURL = MODEL_URL + 'model.json';
                const metadataURL = MODEL_URL + 'metadata.json';
                
                // Load the model and metadata
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                
                // Setup webcam
                const flip = true;
                const width = 150;
                const height = 150;
                webcam = new tmImage.Webcam(width, height, flip);
                await webcam.setup();
                
                // Show webcam container
                document.getElementById('webcam-container').style.display = 'block';
                document.getElementById('label-container').style.display = 'block';
                
                if (isIos) {
                    document.getElementById('webcam-container').appendChild(webcam.webcam);
                    const webCamVideo = document.getElementsByTagName('video')[0];
                    webCamVideo.setAttribute("playsinline", true);
                    webCamVideo.muted = "true";
                    webCamVideo.style.width = width + 'px';
                    webCamVideo.style.height = height + 'px';
                } else {
                    document.getElementById("webcam-container").appendChild(webcam.canvas);
                }
                
                // Setup label container
                labelContainer = document.getElementById('label-container');
                labelContainer.innerHTML = '';
                for (let i = 0; i < maxPredictions; i++) {
                    labelContainer.appendChild(document.createElement('div'));
                }
                
                webcam.play();
                gestureControlActive = true;
                document.getElementById('gesture-status').innerHTML = 'Gesture Control: READY';
                
                // Start gesture recognition loop
                gestureLoop();
                
            } catch (error) {
                console.error('Error loading model:', error);
                document.getElementById('gesture-status').innerHTML = 'Error loading model!';
                throw error; // Re-throw to be handled by calling function
            }
        }

        async function gestureLoop() {
            if (gestureControlActive && webcam) {
                webcam.update();
                await predict();
                window.requestAnimationFrame(gestureLoop);
            }
        }

        async function predict() {
            let prediction;
            if (isIos) {
                prediction = await model.predict(webcam.webcam);
            } else {
                prediction = await model.predict(webcam.canvas);
            }
            
            let highestPrediction = prediction[0];
            for (let i = 1; i < maxPredictions; i++) {
                if (prediction[i].probability > highestPrediction.probability) {
                    highestPrediction = prediction[i];
                }
            }
            
            // Update current gesture if confidence is high enough
            if (highestPrediction.probability > 0.7) {
                currentGesture = highestPrediction.className.toLowerCase();
                gestureConfidence = highestPrediction.probability;
                handleGestureControl(currentGesture);
            } else {
                // Stop movement if no confident gesture detected
                stopAllMovement();
            }
            
            // Update label container
            for (let i = 0; i < maxPredictions; i++) {
                const classPrediction = prediction[i].className + ': ' + 
                    (prediction[i].probability * 100).toFixed(1) + '%';
                labelContainer.childNodes[i].innerHTML = classPrediction;
            }
        }

        function handleGestureControl(gesture) {
            if (game_over) return;
            
            // Stop all current movements first
            stopAllMovement();
            
            // Start new movement based on gesture
            switch(gesture) {
                case 'left':
                    if (!move_left) {
                        move_left = requestAnimationFrame(left);
                    }
                    break;
                case 'right':
                    if (!move_right) {
                        move_right = requestAnimationFrame(right);
                    }
                    break;
                case 'up':
                    if (!move_up) {
                        move_up = requestAnimationFrame(up);
                    }
                    break;
                case 'down':
                    if (!move_down) {
                        move_down = requestAnimationFrame(down);
                    }
                    break;
            }
        }

        function stopAllMovement() {
            if (move_left) {
                cancelAnimationFrame(move_left);
                move_left = false;
            }
            if (move_right) {
                cancelAnimationFrame(move_right);
                move_right = false;
            }
            if (move_up) {
                cancelAnimationFrame(move_up);
                move_up = false;
            }
            if (move_down) {
                cancelAnimationFrame(move_down);
                move_down = false;
            }
        }

        // Movement functions
        function left() {
            if (game_over === false && parseInt(car.css('left')) > line_width_l) {
                car.css('left', parseInt(car.css('left')) - 5);
                move_left = requestAnimationFrame(left);
            }
        }
        
        function right() {
            if (game_over === false && parseInt(car.css('left')) < container_width - car_width - line_width_r) {
                car.css('left', parseInt(car.css('left')) + 5);
                move_right = requestAnimationFrame(right);
            }
        }
        
        function up() {
            if (game_over === false && parseInt(car.css('top')) > 10) {
                car.css('top', parseInt(car.css('top')) - 3);
                move_up = requestAnimationFrame(up);
            }
        }
        
        function down() {
            if (game_over === false && parseInt(car.css('top')) < container_height - car_height - 10) {
                car.css('top', parseInt(car.css('top')) + 3);
                move_down = requestAnimationFrame(down);
            }
        }

        // Game loop
        function repeat() {
            if (game_over === false) {
                if (collision(car, car_1) || collision(car, car_2) || collision(car, car_3)) {
                    stop_the_game();
                }
                score_counter++;
                if (score_counter % 20 == 0) {
                    score.text(parseInt(score.text()) + 1);
                }
                if (score_counter % 500 == 0) {
                    speed++;
                    line_speed++;
                }
                car_down(car_1);
                car_down(car_2);
                car_down(car_3);
                line_down(line_1);
                line_down(line_2);
                line_down(line_3);
                line_down(line_4);
                anim_id = requestAnimationFrame(repeat);
            }
        }

        function car_down(car) {
            var car_current_top = parseInt(car.css('top'));
            if (car_current_top > container_height) {
                car_current_top = -200;
                var car_left = parseInt(Math.random() * (container_width - car_width - line_width_l));
                car.css('left', car_left);
            }
            car.css('top', car_current_top + speed);
        }

        function line_down(line) {
            var line_current_top = parseInt(line.css('top'));
            if (line_current_top > container_height) {
                line_current_top = -200;
            }
            line.css('top', line_current_top + line_speed);
        }

        function stop_the_game() {
            game_over = true;
            stopAllMovement();
            cancelAnimationFrame(anim_id);
            restart_div.slideDown();
            restart_btn.focus();
        }

        function collision($div1, $div2) {
            var x1 = $div1.offset().left,
                y1 = $div1.offset().top,
                h1 = $div1.outerHeight(true),
                w1 = $div1.outerWidth(true),
                b1 = y1 + h1,
                r1 = x1 + w1,
                x2 = $div2.offset().left,
                y2 = $div2.offset().top,
                h2 = $div2.outerHeight(true),
                w2 = $div2.outerWidth(true),
                b2 = y2 + h2,
                r2 = x2 + w2;
            if (b1 < y2 || y1 > b2 || r1 < x2 || x1 > r2) return false;
            return true;
        }

        // Return button functionality
        document.getElementById("return").onclick = function () {
            if (typeof Main_menu !== 'undefined') {
                location.href = "Main_menu.html";
            } else {
                // Store the model URL in the page URL for return functionality  
                if (STORED_MODEL_URL) {
                    const currentUrl = window.location.href.split('?')[0];
                    window.location.href = currentUrl + '?modelUrl=' + encodeURIComponent(STORED_MODEL_URL);
                } else {
                    location.reload();
                }
            }
        };
    </script>
</body>

</html>